<html>
<head>
    <title></title>
    <script type="text/javascript" src="https://paichat.herokuapp.com/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css" />
	<style>
		body{
			font-size: 15px;
		}
		#messages {
			width: 90%;
			height: 32em;
			border: 1px solid grey;
			overflow: auto;
			
		}
	</style>
	<script>count = 0;
	var audio = new Audio('https://notificationsounds.com/soundfiles/cf67355a3333e6e143439161adc2d82e/file-sounds-874-gets-in-the-way.mp3');
	</script>
</head>
<body>
    <div class="container">
		<i><h2>Welcome to Pai Chat</h2></i>
		<form action="">
			<table class="table">
				<tr>
					<td>
						<input type="text" class="form-control" id="field1" />
					</td>
					<td>
						<input type="text" class="form-control" id="field2" required="required" />
					</td>
					<td>
						<button class="btn btn-primary" id="send">Send</button>
					</td>
				</tr>
			</table>
		</form>
		
		<script type="text/javascript">
			var socket = io.connect('https://paichat.herokuapp.com');
			var sockid, counter = 0, exiter="";

			socket.emit('ferret', 'id', function (data) {
		      	sockid = data;
		    });

			$('form').submit(function(){
				socket.emit('send', {sockid: sockid, username: $('#field1').val(), message: $('#field2').val()} );
				$('#field2').val('');
				$('#field1').prop( "disabled", true );
				return false;
			});

			socket.on('message', function(data){
				if(count++ >= 22)
					$('#messages li').first().remove();
				if(sockid == data.sockid)
					$('#messages').append($("<li align='right'>").text(data.message));
				else {
					$('#messages').append($("<li>").text(data.username + ": " + data.message));
					audio.play();
				}
				$('#field2').focus();
				
			});

			socket.on('counter', function(data){
				if(counter != 0){
					if(counter < data)
						$('#messages').append($("<li style='background-color:lightgrey' align='center'>").text("New user joined"));
					else if(counter > data)
						$('#messages').append($("<li style='background-color:lightgrey' align='center'>").text(((exiter == "") ? "User" : exiter) + " left"));
				}

				counter = data;
				$('#counter').html(data);
			});

			socket.on('exit', function(data){
				exiter = data;
			});

			socket.on('typing', function(data){
				$('#typer').html(data + ' is typing');
				setTimeout(function () {
		            $('#typer').html('');
		        }, 3000);
			});

			$("#field2").on('input', function(){
				if($('#field1').val() != "")
			    	socket.emit('typing', $('#field1').val());
			});

			$(window).on('beforeunload', function() {
			    socket.emit('exit', $('#field1').val());
			});

		</script>
			
		<ul id="messages"></ul>
		<table width="100%">
			<tr>
				<td>Number of connected users: <b><span id="counter"></span></b></td>
				<td><span id="typer" style="color:grey;text-align:right"></span></td>
			</tr>
		</table>
	    
	    
    </div>
</body>
</html>
